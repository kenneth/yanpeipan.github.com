---
layout: post
title: "高并发抽奖"
description: ""
category: 
tags: [高并发]
---
{% include JB/setup %}


# 高并发库存防控超量
在秒杀，抽奖等活动中，避免商品超卖甚至库存变负数的问题。

## 锁
锁是用来做并发最简单的方式，其代价也是最高的

### 数据库锁
通过`update`返回值来判断库存:

`update {{table}} set number=number-1 where number > 0`

`update {{table}} set number=if(number>0, number-1, number)`


* MyISAM 表级锁，大量的更新操作会造成查询操作的阻塞, 可以用存储过程来实现数据一致性
* InnoDB 多版本行级锁, 更小的锁粒度, 支持更多的并发，同时性能下降很快，支持事物

### 文件锁

    if (flock($fp, LOCK_EX)) {
	    flock($fp, LOCK_UN);
    }

## 消息队列
把奖品塞到队列里, 按照`FIFO`顺序执行

### Beanstalk
Beanstalk is a simple, fast work queue.

### Redis
redis的数据类list可以用来实现队列, 左边压入`lpush`, 右边弹出`rpop`。

### MemcacheQ 
Simple Queue Service over Memcache

# 参考
[双11抽奖活动平台测试总结](http://www.taobaotest.com/blogs/2338)  
[一种高效无锁内存队列的实现](http://www.searchtb.com/2012/10/introduction_to_disruptor.html)  
[Beanstalk  is a simple, fast work queue](http://kr.github.io/beanstalkd/)  
[Redis 命令参考](http://redis.readthedocs.org/en/latest/index.html)  
[使用 Redis 实现分布式锁](http://www.oschina.net/translate/redis-distlock)  
